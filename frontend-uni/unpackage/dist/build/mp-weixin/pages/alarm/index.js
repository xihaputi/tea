"use strict";const a=require("../../common/vendor.js"),t=require("../../api/alarm.js"),s=require("../../api/task.js"),e=require("../../common/assets.js"),i={data:()=>({activeModule:"alarm",alarmTabs:["未读","已处理","全部"],currentAlarmTab:0,alarms:[],tasks:[],page:1,pageSize:10,total:0,loading:!1,hasMore:!0,isRefreshing:!1}),onLoad(){this.loadData()},onPullDownRefresh(){this.isRefreshing=!0,this.page=1,this.hasMore=!0,this.loadData()},onReachBottom(){this.hasMore&&!this.loading&&(this.page++,this.loadData())},watch:{activeModule(){this.resetPagination(),this.loadData()},currentAlarmTab(){"alarm"===this.activeModule&&(this.resetPagination(),this.loadData())}},methods:{switchModule(a){this.activeModule=a},resetPagination(){this.page=1,this.hasMore=!0,this.alarms=[],this.tasks=[]},async loadData(){if(!this.loading){this.loading=!0;try{"alarm"===this.activeModule?await this.loadAlarms():await this.loadTasks()}catch(t){console.error(t),a.index.showToast({title:"加载失败",icon:"none"})}finally{this.loading=!1,this.isRefreshing&&(this.isRefreshing=!1,a.index.stopPullDownRefresh())}}},async loadAlarms(){let a="";0===this.currentAlarmTab?a="active":1===this.currentAlarmTab&&(a="cleared");const s=await t.getAlarmList({page:this.page,size:this.pageSize,status:a}),e=s.list||[];1===this.page?this.alarms=e:this.alarms=[...this.alarms,...e],this.total=s.total||0,this.hasMore=this.alarms.length<this.total},async loadTasks(){const a=await s.getTaskList({page:this.page,size:this.pageSize,status:"pending"}),t=a.list||[];1===this.page?this.tasks=t:this.tasks=[...this.tasks,...t],this.total=a.total||0,this.hasMore=this.tasks.length<this.total},severityClass:a=>"critical"===a?"bg-critical":"warning"===a?"bg-warning":"bg-info",statusTagClass:a=>"active"===a?"tag-danger":"tag-primary",statusText:a=>"active"===a?"待处理":"已恢复",handleAlarm(s){"active"===s.status&&a.index.showActionSheet({itemList:["标记为已处理"],success:async e=>{if(0===e.tapIndex)try{await t.acknowledgeAlarm(s.id),a.index.showToast({title:"已标志处理",icon:"success"}),this.resetPagination(),this.loadData()}catch(i){a.index.showToast({title:"操作失败",icon:"none"})}}})},priorityText:a=>({high:"高",medium:"中",low:"低"}[a]||"普通"),formatDate:a=>a?new Date(a).toLocaleDateString():"",async completeTask(t){"completed"!==t.status&&a.index.showModal({title:"确认",content:"确定标记该任务为已完成吗？",success:async e=>{if(e.confirm)try{await s.updateTask(t.id,{status:"completed"}),a.index.showToast({title:"任务已完成"}),this.resetPagination(),this.loadData()}catch(i){a.index.showToast({title:"操作失败",icon:"none"})}}})},handleTask(a){}}};const o=a._export_sfc(i,[["render",function(t,s,i,o,l,n){return a.e({a:"alarm"===l.activeModule?1:"",b:a.o((a=>n.switchModule("alarm"))),c:"task"===l.activeModule?1:"",d:a.o((a=>n.switchModule("task"))),e:"alarm"===l.activeModule},"alarm"===l.activeModule?{f:a.f(l.alarmTabs,((t,s,e)=>({a:a.t(t),b:s,c:l.currentAlarmTab===s?1:"",d:a.o((a=>l.currentAlarmTab=s),s)})))}:{},{g:"alarm"===l.activeModule},"alarm"===l.activeModule?a.e({h:a.f(l.alarms,((t,s,e)=>({a:a.t(t.gardenName||"未知茶园"),b:a.t(t.deviceName||"未知设备"),c:a.t(t.created_at),d:a.n(n.severityClass(t.severity)),e:a.t(t.content),f:a.t(n.statusText(t.status)),g:a.n(n.statusTagClass(t.status)),h:a.o((a=>n.handleAlarm(t)),t.id),i:t.id}))),i:l.loading},(l.loading,{}),{j:!l.loading&&0===l.alarms.length},l.loading||0!==l.alarms.length?{}:{k:e._imports_0}):{},{l:"task"===l.activeModule},"task"===l.activeModule?a.e({m:a.f(l.tasks,((t,s,e)=>({a:a.t(t.name),b:a.t(n.priorityText(t.priority)),c:a.n("p-"+(t.priority||"medium")),d:a.t(t.description||"暂无描述"),e:a.t(n.formatDate(t.deadline)||"无截止日期"),f:a.t(t.assignee||"未分配"),g:a.t("completed"===t.status?"已完成":"进行中"),h:a.n(t.status),i:a.t("completed"===t.status?"已归档":"标记完成"),j:a.o((a=>n.completeTask(t)),t.id),k:t.id,l:a.o((a=>n.handleTask(t)),t.id)}))),n:l.loading},(l.loading,{}),{o:!l.loading&&0===l.tasks.length},l.loading||0!==l.tasks.length?{}:{p:e._imports_0}):{})}],["__scopeId","data-v-f7fdf8f9"]]);wx.createPage(o);
