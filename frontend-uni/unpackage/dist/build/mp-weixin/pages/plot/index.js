"use strict";const e=require("../../common/vendor.js"),t=require("../../api/garden.js"),a=require("../../api/device.js"),n=require("../../api/rule.js"),s=require("../../common/assets.js"),i={data:()=>({gardenId:null,garden:{},devices:[],loading:!1,lastUpdated:"",rulesMap:{},weather:{temperature:"24",weather:"å¤šäº‘",humidity:"65",windPower:"2"},sensorList:[],aiAdvice:[{type:"info",text:"æ­£åœ¨åˆ†æç¯å¢ƒæ•°æ®..."}]}),computed:{gardenImage(){return this.garden.image_path?this.$baseUrl+this.garden.image_path:"/static/garden_bg.png"},gardenStatusText(){return"normal"===(this.garden.status||"normal")?"æ­£å¸¸è¿è¡Œ":"éœ€å…³æ³¨"},gardenStatusClass(){return"normal"===(this.garden.status||"normal")?"tag-primary":"tag-warn"}},onLoad(e){e.garden_id&&(this.gardenId=e.garden_id,this.loadData())},onPullDownRefresh(){this.loadData().then((()=>{e.index.stopPullDownRefresh()}))},methods:{async loadData(){this.loading=!0;try{await this.fetchRules();const[a,n]=await Promise.all([t.getGardenDetail(this.gardenId),t.getGardenDevices(this.gardenId)]);this.garden=a,this.devices=n,e.index.setNavigationBarTitle({title:a.name}),await this.fetchSensorData(n)}catch(a){console.error(a),e.index.showToast({title:"åŠ è½½å¤±è´¥",icon:"none"})}finally{this.loading=!1}},async fetchRules(){try{const e=await n.getSensorRules();e&&e.forEach((e=>{try{this.rulesMap[e.sensor_key]=JSON.parse(e.rule_config)}catch(t){}}))}catch(e){console.error("Fetch rules failed",e)}},computeStatus(e,t){const a=parseFloat(t);if(isNaN(a))return null;const n=this.rulesMap[e];if(!n)return null;for(const s of n){const e=null!==s.min&&void 0!==s.min?s.min:-1/0,t=null!==s.max&&void 0!==s.max?s.max:1/0;if(a>=e&&a<t)return{label:s.label,color:s.color}}return null},async fetchSensorData(e){const t=[],n=e.map((async e=>{try{const s=await a.getLatestTelemetry(e.id);let i={};try{e.sensor_config&&(i=JSON.parse(e.sensor_config))}catch(n){}const r={};Array.isArray(s)?s.forEach((e=>{r[e.key]||(r[e.key]=e.value)})):"object"==typeof s&&Object.assign(r,s);for(const[a,n]of Object.entries(r)){if(i.__ignored&&i.__ignored.includes(a))continue;if("ts"===a)continue;if(["battery","signal","version"].includes(a))continue;const s=i[a]||{},r=s.name||this.formatKeyName(a),o=s.unit||this.guessUnit(a),d=this.computeStatus(a,n);t.push({label:r,value:n+o,rawVal:parseFloat(n),key:a,deviceName:e.name,status:d?d.label:null,statusColor:d?d.color:null})}}catch(n){console.error(`Device ${e.id} telemetry error`,n)}}));await Promise.all(n),this.sensorList=t,this.lastUpdated=(new Date).toLocaleTimeString(),this.generateAiAdvice(t)},formatKeyName:e=>({temperature:"æ¸©åº¦",humidity:"æ¹¿åº¦",soil_moisture:"åœŸå£¤æ¹¿åº¦",light:"å…‰ç…§",co2:"CO2æµ“åº¦"}[e]||e),guessUnit:e=>e.includes("temp")?"â„ƒ":e.includes("humidity")||e.includes("moisture")?"%":e.includes("light")?"Lux":"",generateAiAdvice(e){const t=[],a=e.find((e=>e.key.includes("temp")));e.find((e=>e.key.includes("humidity")));const n=e.find((e=>e.key.includes("soil")));a&&(a.rawVal>30?t.push({type:"warning",text:`æ°”æ¸©è¾ƒé«˜(${a.value})ï¼Œæ³¨æ„èŒ¶æ ‘é˜²æ™’ã€‚`}):a.rawVal<5&&t.push({type:"warning",text:`æ°”æ¸©è¾ƒä½(${a.value})ï¼Œæ³¨æ„é˜²å†»ã€‚`})),n&&n.rawVal<30&&t.push({type:"warning",text:`åœŸå£¤è¾ƒå¹²(${n.value})ï¼Œå»ºè®®çŒæº‰ã€‚`}),0===t.length&&(t.push({type:"info",text:"å½“å‰ç¯å¢ƒé€‚å®œï¼ŒèŒ¶æ ‘ç”Ÿé•¿çŠ¶å†µè‰¯å¥½ã€‚"}),t.push({type:"info",text:"å»ºè®®è¿›è¡Œå¸¸è§„å·¡å›­æ£€æŸ¥ã€‚"})),this.aiAdvice=t},goEdit(){e.index.navigateTo({url:`/pages/plot/edit_garden?id=${this.gardenId}`})},deviceStatusText:e=>"online"===e?"åœ¨çº¿":"ç¦»çº¿",deviceStatusClass:e=>"online"===e?"text-primary":"text-sub",formatTime:e=>e?new Date(e).toLocaleString():"-",goDeviceDetail(t){e.index.showToast({title:"è®¾å¤‡è¯¦æƒ…å¼€å‘ä¸­",icon:"none"})}}};const r=e._export_sfc(i,[["render",function(t,a,n,i,r,o){return e.e({a:r.garden.name},r.garden.name?e.e({b:o.gardenImage,c:e.t(r.garden.name),d:e.t(o.gardenStatusText),e:e.n(o.gardenStatusClass),f:e.o(((...e)=>o.goEdit&&o.goEdit(...e))),g:e.t(r.garden.company||"æœªå½’å±å…¬å¸"),h:r.garden.manager},r.garden.manager?{i:e.t(r.garden.manager)}:{}):{},{j:e.t(r.garden.address||"åœ°å€æœªé…ç½®"),k:e.t(r.weather.temperature),l:e.t(r.weather.weather),m:e.t(r.weather.humidity),n:e.t(r.weather.windPower),o:r.lastUpdated},r.lastUpdated?{p:e.t(r.lastUpdated)}:{},{q:r.sensorList.length>0},r.sensorList.length>0?{r:e.f(r.sensorList,((t,a,n)=>({a:e.t(t.status||"ç›‘æµ‹ä¸­"),b:t.statusColor||"#333",c:e.t(t.label),d:e.t(t.value),e:a})))}:{},{s:e.f(r.aiAdvice,((t,a,n)=>({a:e.t("warning"===t.type?"âš ï¸":"ğŸ’¡"),b:e.t(t.text),c:a,d:e.n(t.type)}))),t:e.t(r.devices.length),v:e.f(r.devices,((t,a,n)=>({a:e.t(t.name),b:e.t(o.deviceStatusText(t.status)),c:e.n(o.deviceStatusClass(t.status)),d:e.t(o.formatTime(t.last_time)),e:e.t(t.sn),f:t.id,g:e.o((e=>o.goDeviceDetail(t.id)),t.id)}))),w:0===r.devices.length&&!r.loading},0!==r.devices.length||r.loading?{}:{x:s._imports_0})}],["__scopeId","data-v-a1259b4b"]]);wx.createPage(r);
