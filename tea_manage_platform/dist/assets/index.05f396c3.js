import{g as l,a as e,u as a,c as o,d as n,b as t,e as u}from"./rule.85422e5a.js";import{c as d,g as i}from"./device.2995e9c4.js";import{e as r,f as s,g as c,r as m,$ as p,o as f,i as b,a as _,w as y,j as v,F as h,y as x,l as V,m as w,k as g,c as k,q as C,E as U,H as A}from"./vendor.da7b8729.js";import"./index.e41e9f95.js";const F={class:"app-container"},E={class:"flex justify-between items-center"},j={class:"flex items-center gap-4"},$={key:0},z={key:0},O={class:"font-bold"},P={key:0,class:"flex flex-wrap gap-2"},I={key:1,class:"text-gray-400 text-sm"},J={key:1,class:"text-center py-10 text-gray-400"},M={class:"flex justify-between"},N={key:1},S={class:"bg-gray-50 p-4 rounded mb-4"},H={class:"font-bold mb-2"},q={class:"w-full"},D={__name:"index",setup(D){const K=r("status"),T=r(!1),B=r(null),G=r([]),L=r({}),Q=r(!1),R=r(null),W=r(""),X=s({name:"",sensor_key:"",config:[]}),Y=r(!1);r(["生成系统告警"]);const Z=r([]),ll=r([]),el=r([]),al=s({name:"",product_id:null,device_id:null,input_key:"",operator:">",threshold:null}),ol=async()=>{try{const e=await l(),a={};e&&e.forEach((l=>{a[l.sensor_key]=l})),L.value=a}catch(e){console.error(e)}},nl=async l=>{T.value=!0,G.value=[];try{await ol();const a=await i({productId:l,size:1});if(a&&a.list&&a.list.length>0){const l=a.list[0];if(l.sensor_config)try{const e=JSON.parse(l.sensor_config),a=[];for(const l in e){if("__ignored"===l)continue;const o=e[l];a.push({key:l,name:o.name||l,rule:L.value[l]||null})}G.value=a}catch(e){console.error("Parse config error",e),U.warning("设备配置解析失败")}else U.info("该类型设备暂无默认传感器配置")}else U.warning("未找到该类型的设备，无法加载传感器列表")}catch(e){console.error(e),U.error("加载传感器失败")}finally{T.value=!1}},tl=l=>{try{return JSON.parse(l)}catch(e){return[]}},ul=l=>{const e=null!==l.min&&void 0!==l.min?l.min:"",a=null!==l.max&&void 0!==l.max?l.max:"";return""===e&&""===a?"Any":""===e?`< ${a}`:""===a?`≥ ${e}`:`${e} ~ ${a}`},dl=()=>{X.config.push({min:null,max:null,label:"",color:"#409EFF"})},il=l=>{"air_temp"===l?X.config=[{min:18,max:30,label:"适宜生长",color:"#67C23A"},{min:32,max:null,label:"高温风险",color:"#F56C6C"},{min:null,max:5,label:"低温风险",color:"#409EFF"}]:"humidity"===l?X.config=[{min:70,max:90,label:"适宜",color:"#67C23A"},{min:null,max:60,label:"干燥",color:"#E6A23C"},{min:95,max:null,label:"高湿风险",color:"#F56C6C"}]:"soil_humi"===l?X.config=[{min:60,max:80,label:"适宜",color:"#67C23A"},{min:null,max:50,label:"轻度干旱",color:"#E6A23C"},{min:90,max:null,label:"渍害风险",color:"#F56C6C"}]:"soil_ph"===l?X.config=[{min:4.5,max:5.5,label:"最适区间",color:"#67C23A"},{min:null,max:4.2,label:"酸化风险",color:"#E6A23C"},{min:5.8,max:null,label:"偏碱风险",color:"#F56C6C"}]:"lux"===l&&(X.config=[{min:1e4,max:5e4,label:"光照适宜",color:"#67C23A"},{min:null,max:5e3,label:"光照不足",color:"#E6A23C"},{min:8e4,max:null,label:"强光灼伤",color:"#F56C6C"}])},rl=async()=>{try{const l={name:X.name,sensor_key:X.sensor_key,rule_config:JSON.stringify(X.config)};R.value?await a(R.value,l):await o(l),U.success("配置已保存"),Q.value=!1,await ol(),B.value&&await nl(B.value)}catch(l){console.error(l)}},sl=async()=>{try{const l=await e();l&&(Z.value=l.list||[])}catch(l){console.error(l)}},cl=async l=>{al.device_id=null;const e=await i({productId:l,size:100});el.value=e.list||[]},ml=async()=>{try{await t(al),U.success("规则创建成功"),Y.value=!1,sl()}catch(l){console.error(l)}};return c((()=>{ol(),sl(),(async()=>{const l=await d();ll.value=l||[]})()})),(l,e)=>{const a=m("el-option"),o=m("el-select"),t=m("el-alert"),d=m("el-table-column"),i=m("el-tag"),r=m("el-button"),s=m("el-table"),c=m("Operation"),D=m("el-icon"),L=m("el-card"),ol=m("el-tab-pane"),pl=m("el-switch"),fl=m("el-tabs"),bl=m("el-form-item"),_l=m("el-input"),yl=m("el-input-number"),vl=m("el-color-picker"),hl=m("el-form"),xl=m("el-dialog"),Vl=m("el-divider"),wl=m("el-col"),gl=m("el-row"),kl=p("loading");return f(),b("div",F,[_(fl,{modelValue:K.value,"onUpdate:modelValue":e[2]||(e[2]=l=>K.value=l),type:"card",class:"demo-tabs"},{default:y((()=>[_(ol,{label:"状态映射规则",name:"status"},{default:y((()=>[_(L,{shadow:"never"},{header:y((()=>[v("div",E,[v("div",j,[e[14]||(e[14]=v("div",null,[v("span",{class:"font-bold text-lg"},"传感器状态映射"),v("div",{class:"text-gray-400 text-xs mt-1"},"根据设备类型配置传感器状态显示规则")],-1)),_(o,{modelValue:B.value,"onUpdate:modelValue":e[0]||(e[0]=l=>B.value=l),placeholder:"请选择设备类型以配置",onChange:nl,style:{width:"200px"}},{default:y((()=>[(f(!0),b(h,null,x(ll.value,(l=>(f(),k(a,{key:l.id,label:l.label,value:l.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])]),B.value?w("",!0):(f(),b("div",$,[_(t,{type:"info","show-icon":"",closable:!1},{default:y((()=>[...e[15]||(e[15]=[V("请先选择设备类型",-1)])])),_:1})]))])])),default:y((()=>[B.value?(f(),b("div",z,[g((f(),k(s,{data:G.value,"empty-text":"未找到该产品的传感器配置或无设备"},{default:y((()=>[_(d,{prop:"name",label:"传感器名称",width:"180"},{default:y((({row:l})=>[v("span",O,C(l.name),1)])),_:1}),_(d,{prop:"key",label:"标识 (Key)",width:"150"},{default:y((({row:l})=>[_(i,{type:"info",size:"small"},{default:y((()=>[V(C(l.key),1)])),_:2},1024)])),_:1}),_(d,{label:"当前状态规则","min-width":"400"},{default:y((({row:l})=>[l.rule?(f(),b("div",P,[(f(!0),b(h,null,x(tl(l.rule.rule_config),((l,e)=>(f(),k(i,{key:e,color:l.color,effect:"dark",style:{border:"none"}},{default:y((()=>[V(C(ul(l))+" : "+C(l.label),1)])),_:2},1032,["color"])))),128))])):(f(),b("span",I,"暂无配置，显示默认数值"))])),_:1}),_(d,{label:"操作",width:"120",fixed:"right"},{default:y((({row:l})=>[_(r,{type:"primary",link:"",onClick:e=>(l=>{W.value=l.name,X.sensor_key=l.key,X.name=l.rule?l.rule.name:l.name+"状态规则",R.value=l.rule?l.rule.id:null,l.rule?X.config=tl(l.rule.rule_config):(X.config=[{min:0,max:100,label:"正常",color:"#67C23A"}],l.name.includes("温度")?il("air_temp"):l.name.includes("湿度")?il("humidity"):l.name.includes("土壤")&&il("soil_humi")),Q.value=!0})(l)},{default:y((()=>[V(C(l.rule?"修改配置":"去配置"),1)])),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data"])),[[kl,T.value]])])):(f(),b("div",J,[_(D,{size:48},{default:y((()=>[_(c)])),_:1}),e[16]||(e[16]=v("div",{class:"mt-2"},"请在左上角选择设备类型，以查看和配置对应的传感器规则",-1))]))])),_:1})])),_:1}),_(ol,{label:"告警触发规则",name:"alarm"},{default:y((()=>[_(L,{shadow:"never"},{header:y((()=>[v("div",M,[e[18]||(e[18]=v("span",null,"自动化告警规则列表",-1)),_(r,{type:"primary",icon:"Plus",onClick:e[1]||(e[1]=l=>Y.value=!0)},{default:y((()=>[...e[17]||(e[17]=[V("新建告警规则",-1)])])),_:1})])])),default:y((()=>[_(s,{data:Z.value},{default:y((()=>[_(d,{prop:"name",label:"规则名称",width:"200"}),_(d,{label:"触发条件 (If)","min-width":"250"},{default:y((({row:l})=>[l.input_key?(f(),k(i,{key:0,effect:"plain"},{default:y((()=>[V(C(l.input_key)+" "+C(l.operator)+" "+C(l.threshold),1)])),_:2},1024)):(f(),b("span",N,C(l.condition),1))])),_:1}),_(d,{label:"执行动作 (Then)","min-width":"250"},{default:y((({row:l})=>[_(i,{type:"warning"},{default:y((()=>[...e[19]||(e[19]=[V("生成系统告警",-1)])])),_:1})])),_:1}),_(d,{prop:"enabled",label:"启用",width:"100"},{default:y((({row:l})=>[_(pl,{modelValue:l.enabled,"onUpdate:modelValue":e=>l.enabled=e,onChange:e=>(async l=>{try{await u(l.id,l.enabled),U.success("状态更新成功")}catch(e){l.enabled=!l.enabled,console.error(e)}})(l)},null,8,["modelValue","onUpdate:modelValue","onChange"])])),_:1}),_(d,{label:"操作",width:"100"},{default:y((({row:l})=>[_(r,{link:"",type:"danger",onClick:e=>(async l=>{A.confirm("确认删除?","提示").then((async()=>{await n(l.id),sl()}))})(l)},{default:y((()=>[...e[20]||(e[20]=[V("删除",-1)])])),_:1},8,["onClick"])])),_:1})])),_:1},8,["data"])])),_:1})])),_:1})])),_:1},8,["modelValue"]),_(xl,{modelValue:Q.value,"onUpdate:modelValue":e[5]||(e[5]=l=>Q.value=l),title:"配置状态规则",width:"700px"},{footer:y((()=>[_(r,{onClick:e[4]||(e[4]=l=>Q.value=!1)},{default:y((()=>[...e[24]||(e[24]=[V("取消",-1)])])),_:1}),_(r,{type:"primary",onClick:rl},{default:y((()=>[...e[25]||(e[25]=[V("保存配置",-1)])])),_:1})])),default:y((()=>[_(hl,{model:X,"label-width":"100px"},{default:y((()=>[v("div",S,[v("div",H,C(W.value)+" ("+C(X.sensor_key)+")",1),e[21]||(e[21]=v("div",{class:"text-xs text-gray-500"},"为该传感器配置不同数值区间对应的状态显示",-1))]),_(bl,{label:"规则模板"},{default:y((()=>[_(o,{placeholder:"选择模板快速填充",onChange:il},{default:y((()=>[_(a,{label:"空气温度标准",value:"air_temp"}),_(a,{label:"空气湿度标准",value:"humidity"}),_(a,{label:"土壤水分标准",value:"soil_humi"}),_(a,{label:"土壤PH标准",value:"soil_ph"}),_(a,{label:"光照强度标准",value:"lux"})])),_:1})])),_:1}),_(bl,{label:"规则名称"},{default:y((()=>[_(_l,{modelValue:X.name,"onUpdate:modelValue":e[3]||(e[3]=l=>X.name=l),placeholder:"例如：空气温度判断标准"},null,8,["modelValue"])])),_:1}),_(bl,{label:"状态定义"},{default:y((()=>[v("div",q,[(f(!0),b(h,null,x(X.config,((l,a)=>(f(),b("div",{key:a,class:"flex gap-2 mb-2 items-center"},[_(yl,{modelValue:l.min,"onUpdate:modelValue":e=>l.min=e,controls:!1,placeholder:"Min",style:{width:"80px"}},null,8,["modelValue","onUpdate:modelValue"]),e[22]||(e[22]=v("span",null,"≤ 值 <",-1)),_(yl,{modelValue:l.max,"onUpdate:modelValue":e=>l.max=e,controls:!1,placeholder:"Max",style:{width:"80px"}},null,8,["modelValue","onUpdate:modelValue"]),_(_l,{modelValue:l.label,"onUpdate:modelValue":e=>l.label=e,placeholder:"状态名称",style:{width:"120px"}},null,8,["modelValue","onUpdate:modelValue"]),_(vl,{modelValue:l.color,"onUpdate:modelValue":e=>l.color=e,"show-alpha":""},null,8,["modelValue","onUpdate:modelValue"]),_(r,{circle:"",icon:"Delete",type:"danger",link:"",onClick:l=>(l=>{X.config.splice(l,1)})(a)},null,8,["onClick"])])))),128)),_(r,{type:"primary",link:"",icon:"Plus",onClick:dl},{default:y((()=>[...e[23]||(e[23]=[V("添加状态区间",-1)])])),_:1})])])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue"]),_(xl,{modelValue:Y.value,"onUpdate:modelValue":e[13]||(e[13]=l=>Y.value=l),title:"配置告警规则",width:"600px"},{footer:y((()=>[_(r,{onClick:e[12]||(e[12]=l=>Y.value=!1)},{default:y((()=>[...e[28]||(e[28]=[V("取消",-1)])])),_:1}),_(r,{type:"primary",onClick:ml},{default:y((()=>[...e[29]||(e[29]=[V("保存",-1)])])),_:1})])),default:y((()=>[_(hl,{model:al,"label-width":"100px"},{default:y((()=>[_(bl,{label:"规则名称"},{default:y((()=>[_(_l,{modelValue:al.name,"onUpdate:modelValue":e[6]||(e[6]=l=>al.name=l),placeholder:"例如：土壤缺水告警"},null,8,["modelValue"])])),_:1}),_(bl,{label:"关联产品"},{default:y((()=>[_(o,{modelValue:al.product_id,"onUpdate:modelValue":e[7]||(e[7]=l=>al.product_id=l),placeholder:"选择产品类型",onChange:cl},{default:y((()=>[(f(!0),b(h,null,x(ll.value,(l=>(f(),k(a,{key:l.id,label:l.label,value:l.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),_(bl,{label:"关联设备"},{default:y((()=>[_(o,{modelValue:al.device_id,"onUpdate:modelValue":e[8]||(e[8]=l=>al.device_id=l),placeholder:"可选：指定特定设备",clearable:""},{default:y((()=>[(f(!0),b(h,null,x(el.value,(l=>(f(),k(a,{key:l.id,label:l.name,value:l.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),e[26]||(e[26]=v("div",{class:"text-gray-400 text-xs"},"不选则应用于该产品下的所有设备",-1))])),_:1}),_(Vl,{"content-position":"left"},{default:y((()=>[...e[27]||(e[27]=[V("触发条件",-1)])])),_:1}),_(bl,{label:"当"},{default:y((()=>[_(gl,{gutter:10},{default:y((()=>[_(wl,{span:8},{default:y((()=>[_(_l,{modelValue:al.input_key,"onUpdate:modelValue":e[9]||(e[9]=l=>al.input_key=l),placeholder:"字段 (如 temperature)"},null,8,["modelValue"])])),_:1}),_(wl,{span:6},{default:y((()=>[_(o,{modelValue:al.operator,"onUpdate:modelValue":e[10]||(e[10]=l=>al.operator=l),placeholder:"操作符"},{default:y((()=>[_(a,{label:">",value:">"}),_(a,{label:"<",value:"<"}),_(a,{label:"=",value:"="}),_(a,{label:">=",value:">="}),_(a,{label:"<=",value:"<="})])),_:1},8,["modelValue"])])),_:1}),_(wl,{span:8},{default:y((()=>[_(_l,{modelValue:al.threshold,"onUpdate:modelValue":e[11]||(e[11]=l=>al.threshold=l),modelModifiers:{number:!0},placeholder:"阈值"},null,8,["modelValue"])])),_:1})])),_:1})])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue"])])}}};export{D as default};
