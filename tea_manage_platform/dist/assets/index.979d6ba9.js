import{f as e,e as a,g as l,r as t,$ as o,o as n,i as d,j as r,a as u,w as i,k as p,c,l as s,a0 as m,q as f,n as y,a3 as _,m as v,H as b,E as g,S as h}from"./vendor.da7b8729.js";import{s as V}from"./index.e41e9f95.js";function w(e,a){return V({url:`/tasks/${e}`,method:"put",data:a})}const k={class:"page-container"},C={class:"card header-card"},U={class:"card filter-card"},z={class:"card table-card"},x={class:"pagination-container"},j={class:"dialog-footer"},S={__name:"index",setup(S){const Y=e({page:1,size:10,name:"",type:""}),$=a([]),D=a(0),H=a(!1),q=a(!1),E=a(!1),I=a(!1),M=a(null),O=a(null),P=e({name:"",type:"cron",cron:"",target_type:"device",target_id:null,action_type:"control",action_data:"{}",enabled:!0}),R={name:[{required:!0,message:"请输入任务名称",trigger:"blur"}],cron:[{validator:(e,a,l)=>{"cron"!==P.type||a?l():l(new Error("请输入Cron表达式"))},trigger:"blur"}]},J=async()=>{H.value=!0;try{const a=await(e=Y,V({url:"/tasks/",method:"get",params:e}));$.value=a.list,D.value=a.total}catch(a){console.error(a)}finally{H.value=!1}var e},K=()=>{Y.page=1,J()},N=()=>{Y.name="",Y.type="",Y.page=1,J()},A=()=>{E.value=!1,O.value=null,L(),q.value=!0},B=e=>{b.confirm("确认删除该任务吗?","警告",{type:"warning"}).then((async()=>{try{await(a=e.id,V({url:`/tasks/${a}`,method:"delete"})),g.success("删除成功"),J()}catch(l){}var a}))},F=async e=>{try{await(a=e.id,V({url:`/tasks/${a}/run`,method:"post"})),g.success("指令已发送"),J()}catch(l){}var a},G=async()=>{M.value&&await M.value.validate((async e=>{if(e){I.value=!0;try{E.value?(await w(O.value,P),g.success("更新成功")):(await(a=P,V({url:"/tasks/",method:"post",data:a})),g.success("创建成功")),q.value=!1,J()}catch(l){}finally{I.value=!1}}var a}))},L=()=>{P.name="",P.type="cron",P.cron="",P.target_type="device",P.action_type="control",P.action_data="{}",P.enabled=!0};return l((()=>{J()})),(e,a)=>{const l=t("el-button"),b=t("el-input"),V=t("el-form-item"),S=t("el-option"),L=t("el-select"),Q=t("el-form"),T=t("el-table-column"),W=t("el-tag"),X=t("el-switch"),Z=t("el-table"),ee=t("el-pagination"),ae=t("el-radio"),le=t("el-radio-group"),te=t("el-icon"),oe=t("el-tooltip"),ne=t("el-divider"),de=t("el-dialog"),re=o("loading");return n(),d("div",k,[r("div",C,[a[14]||(a[14]=r("div",{class:"page-title"},"计划任务",-1)),u(l,{type:"primary",icon:"Plus",onClick:A},{default:i((()=>[...a[13]||(a[13]=[s("新建任务",-1)])])),_:1})]),r("div",U,[u(Q,{inline:!0,model:Y},{default:i((()=>[u(V,{label:"任务名称"},{default:i((()=>[u(b,{modelValue:Y.name,"onUpdate:modelValue":a[0]||(a[0]=e=>Y.name=e),placeholder:"请输入任务名称",clearable:"",onKeyup:m(K,["enter"])},null,8,["modelValue"])])),_:1}),u(V,{label:"类型"},{default:i((()=>[u(L,{modelValue:Y.type,"onUpdate:modelValue":a[1]||(a[1]=e=>Y.type=e),placeholder:"全部类型",clearable:""},{default:i((()=>[u(S,{label:"Cron定时",value:"cron"}),u(S,{label:"一次性",value:"once"})])),_:1},8,["modelValue"])])),_:1}),u(V,null,{default:i((()=>[u(l,{type:"primary",icon:"Search",onClick:K},{default:i((()=>[...a[15]||(a[15]=[s("搜索",-1)])])),_:1}),u(l,{icon:"Refresh",onClick:N},{default:i((()=>[...a[16]||(a[16]=[s("重置",-1)])])),_:1})])),_:1})])),_:1},8,["model"])]),r("div",z,[p((n(),c(Z,{data:$.value,stripe:"",style:{width:"100%"}},{default:i((()=>[u(T,{prop:"id",label:"ID",width:"80"}),u(T,{prop:"name",label:"任务名称","min-width":"150"}),u(T,{prop:"type",label:"类型",width:"100"},{default:i((({row:e})=>[u(W,{type:"cron"===e.type?"primary":"warning"},{default:i((()=>[s(f("cron"===e.type?"定时":"一次性"),1)])),_:2},1032,["type"])])),_:1}),u(T,{prop:"cron",label:"Cron表达式","min-width":"120"}),u(T,{prop:"status",label:"状态",width:"100"},{default:i((({row:e})=>{return[u(W,{type:(a=e.status,"success"===a?"success":"failed"===a?"danger":"running"===a?"primary":"info")},{default:i((()=>[s(f(e.status),1)])),_:2},1032,["type"])];var a})),_:1}),u(T,{prop:"last_run",label:"上次执行",width:"180"},{default:i((({row:e})=>{return[s(f((a=e.last_run,a?h(a).format("YYYY-MM-DD HH:mm:ss"):"-")),1)];var a})),_:1}),u(T,{prop:"enabled",label:"启用",width:"80"},{default:i((({row:e})=>[u(X,{modelValue:e.enabled,"onUpdate:modelValue":a=>e.enabled=a,onChange:a=>(async e=>{try{await w(e.id,{enabled:e.enabled}),g.success("状态更新成功")}catch(a){e.enabled=!e.enabled}})(e)},null,8,["modelValue","onUpdate:modelValue","onChange"])])),_:1}),u(T,{label:"操作",width:"220",fixed:"right"},{default:i((({row:e})=>[u(l,{link:"",type:"primary",onClick:a=>F(e)},{default:i((()=>[...a[17]||(a[17]=[s("立即执行",-1)])])),_:1},8,["onClick"]),u(l,{link:"",type:"primary",onClick:a=>(e=>{E.value=!0,O.value=e.id,Object.assign(P,e),q.value=!0})(e)},{default:i((()=>[...a[18]||(a[18]=[s("编辑",-1)])])),_:1},8,["onClick"]),u(l,{link:"",type:"danger",onClick:a=>B(e)},{default:i((()=>[...a[19]||(a[19]=[s("删除",-1)])])),_:1},8,["onClick"])])),_:1})])),_:1},8,["data"])),[[re,H.value]]),r("div",x,[u(ee,{"current-page":Y.page,"onUpdate:currentPage":a[2]||(a[2]=e=>Y.page=e),"page-size":Y.size,"onUpdate:pageSize":a[3]||(a[3]=e=>Y.size=e),total:D.value,"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:J,onCurrentChange:J},null,8,["current-page","page-size","total"])])]),u(de,{modelValue:q.value,"onUpdate:modelValue":a[12]||(a[12]=e=>q.value=e),title:E.value?"编辑任务":"新建任务",width:"600px"},{footer:i((()=>[r("span",j,[u(l,{onClick:a[11]||(a[11]=e=>q.value=!1)},{default:i((()=>[...a[23]||(a[23]=[s("取消",-1)])])),_:1}),u(l,{type:"primary",onClick:G,loading:I.value},{default:i((()=>[...a[24]||(a[24]=[s("确定",-1)])])),_:1},8,["loading"])])])),default:i((()=>[u(Q,{ref_key:"formRef",ref:M,model:P,rules:R,"label-width":"100px"},{default:i((()=>[u(V,{label:"任务名称",prop:"name"},{default:i((()=>[u(b,{modelValue:P.name,"onUpdate:modelValue":a[4]||(a[4]=e=>P.name=e),placeholder:"请输入任务名称"},null,8,["modelValue"])])),_:1}),u(V,{label:"任务类型",prop:"type"},{default:i((()=>[u(le,{modelValue:P.type,"onUpdate:modelValue":a[5]||(a[5]=e=>P.type=e)},{default:i((()=>[u(ae,{label:"cron"},{default:i((()=>[...a[20]||(a[20]=[s("Cron 定时",-1)])])),_:1}),u(ae,{label:"once"},{default:i((()=>[...a[21]||(a[21]=[s("一次性执行",-1)])])),_:1})])),_:1},8,["modelValue"])])),_:1}),"cron"===P.type?(n(),c(V,{key:0,label:"Cron表达式",prop:"cron"},{default:i((()=>[u(b,{modelValue:P.cron,"onUpdate:modelValue":a[6]||(a[6]=e=>P.cron=e),placeholder:"例如: 0 0 * * * (每天0点)"},{append:i((()=>[u(oe,{content:"分 时 日 月 周",placement:"top"},{default:i((()=>[u(te,null,{default:i((()=>[u(y(_))])),_:1})])),_:1})])),_:1},8,["modelValue"])])),_:1})):v("",!0),u(ne,{"content-position":"left"},{default:i((()=>[...a[22]||(a[22]=[s("执行动作",-1)])])),_:1}),u(V,{label:"目标类型",prop:"target_type"},{default:i((()=>[u(L,{modelValue:P.target_type,"onUpdate:modelValue":a[7]||(a[7]=e=>P.target_type=e),placeholder:"请选择"},{default:i((()=>[u(S,{label:"设备",value:"device"}),u(S,{label:"茶园",value:"garden"}),u(S,{label:"系统",value:"system"})])),_:1},8,["modelValue"])])),_:1}),u(V,{label:"动作类型",prop:"action_type"},{default:i((()=>[u(L,{modelValue:P.action_type,"onUpdate:modelValue":a[8]||(a[8]=e=>P.action_type=e),placeholder:"请选择"},{default:i((()=>[u(S,{label:"控制设备",value:"control"}),u(S,{label:"发送通知",value:"notify"}),u(S,{label:"生成报表",value:"report"})])),_:1},8,["modelValue"])])),_:1}),u(V,{label:"参数数据",prop:"action_data"},{default:i((()=>[u(b,{modelValue:P.action_data,"onUpdate:modelValue":a[9]||(a[9]=e=>P.action_data=e),type:"textarea",rows:3,placeholder:"JSON格式参数, 如: {'switch': 'on'}"},null,8,["modelValue"])])),_:1}),u(V,{label:"是否启用"},{default:i((()=>[u(X,{modelValue:P.enabled,"onUpdate:modelValue":a[10]||(a[10]=e=>P.enabled=e)},null,8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue","title"])])}},__scopeId:"data-v-6181fdcc"};export{S as default};
