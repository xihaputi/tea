import{u as e,f as a,e as l,g as t,r as o,$ as d,o as n,i as u,j as i,k as r,c as s,w as p,a as c,l as m,q as v,a0 as g,E as f,H as h}from"./vendor.da7b8729.js";import{g as y,u as _,c as b,d as w}from"./tea-garden.34ed79bb.js";import{g as V,u as x}from"./device.2995e9c4.js";import{_ as k}from"./ImageSelector.6ec4f0f9.js";import"./index.e41e9f95.js";const C={class:"page"},U={class:"page-header"},z={class:"filters card"},S={class:"card"},j={class:"tag success"},M={class:"pagination"},P=["src"],A={key:1,style:{color:"#909399",display:"flex","flex-direction":"column","align-items":"center"}},L={class:"dialog-footer"},T={class:"dialog-footer"},R={style:{position:"relative"}},q={style:{"margin-bottom":"10px",display:"flex",gap:"10px"}},F={style:{"margin-top":"10px","font-size":"13px",color:"#666"}},I={class:"dialog-footer"},E={__name:"list",setup(E){const B=e(),D=a({name:"",company:"",page:1,size:10}),H=l([]),K=l(0),O=l(!1),W=l(!1),$=l(!1),N=l(!1),Z=l(!1),G=l(null),J=l(null),Q=a({name:"",company:"",manager:"",address:"",area:null,latitude:null,longitude:null,camera_url:"",image_path:"",desc:""}),X={name:[{required:!0,message:"请输入茶园名称",trigger:"blur"}],company:[{required:!0,message:"请选择所属公司",trigger:"change"}],area:[{type:"number",message:"必须为数字值",trigger:"blur",transform:e=>Number(e)}]},Y=l(!1),ee=l(!1),ae=l([]),le=l([]),te=l(null),oe=l(null),de=async()=>{O.value=!0;try{const e=await y(D);e&&(H.value=e.list||[],K.value=e.total||0)}catch(e){console.error(e)}finally{O.value=!1}},ne=()=>{D.page=1,de()},ue=()=>{D.name="",D.company="",D.page=1,de()},ie=e=>{D.page=e,de()},re=()=>{Z.value=!1,G.value=null,se(),$.value=!0},se=()=>{Q.name="",Q.company="",Q.manager="",Q.address="",Q.area=null,Q.latitude=null,Q.longitude=null,Q.camera_url="",Q.image_path="",Q.desc=""},pe=async()=>{J.value&&await J.value.validate((async e=>{if(e){N.value=!0;try{Z.value?(await _(G.value,Q),f.success("更新成功")):(await b(Q),f.success("新增成功")),$.value=!1,de()}catch(a){console.error(a)}finally{N.value=!1}}}))},ce=async()=>{ee.value=!0;try{const e=[];ae.value.forEach((a=>{const l=le.value.includes(a.id),t=a.garden_id===te.value;l&&!t?e.push(x(a.id,{garden_id:te.value})):!l&&t&&e.push(x(a.id,{garden_id:null}))})),e.length>0?(await Promise.all(e),f.success("设备绑定状态已更新")):f.info("未做任何修改"),Y.value=!1,de()}catch(e){console.error(e),f.error("操作失败，请重试")}finally{ee.value=!1}},me=l(!1),ve=l(""),ge=l(null),fe=l(null);let he=null,ye=null,_e=null;const be=()=>{me.value=!0,ge.value=Q.latitude,fe.value=Q.longitude},we=()=>{if(!window.AMap)return void setTimeout(we,500);const e=fe.value&&ge.value?[fe.value,ge.value]:[120.15,30.28];he=new window.AMap.Map("select-map-container",{zoom:12,center:e,viewMode:"3D"}),he.on("click",(e=>{Ve(e.lnglat.getLng(),e.lnglat.getLat())})),fe.value&&ge.value&&Ve(fe.value,ge.value),window.AMap.plugin(["AMap.PlaceSearch"],(function(){_e=new window.AMap.PlaceSearch({pageSize:5,pageIndex:1,city:"010",citylimit:!1,map:he,panel:"panel"})}))},Ve=(e,a)=>{fe.value=parseFloat(e.toFixed(6)),ge.value=parseFloat(a.toFixed(6)),ye?ye.setPosition([e,a]):ye=new window.AMap.Marker({position:[e,a],map:he})},xe=()=>{_e&&ve.value&&_e.search(ve.value,((e,a)=>{if("complete"===e&&"OK"===a.info){if(a.poiList.pois.length>0){const e=a.poiList.pois[0];Ve(e.location.lng,e.location.lat),he.setCenter([e.location.lng,e.location.lat]),he.setZoom(15)}}else f.warning("未找到相关地址")}))},ke=()=>{Q.latitude=ge.value,Q.longitude=fe.value,me.value=!1};return t((()=>{de()})),(e,a)=>{const l=o("el-button"),t=o("el-input"),y=o("el-form-item"),_=o("el-option"),b=o("el-select"),x=o("el-form"),E=o("el-table-column"),O=o("el-table"),se=o("el-pagination"),he=o("Picture"),ye=o("el-icon"),_e=o("el-col"),Ve=o("el-row"),Ce=o("el-dialog"),Ue=o("el-tag"),ze=d("permission");return n(),u("div",C,[i("div",U,[a[24]||(a[24]=i("div",null,[i("div",{class:"eyebrow"},"茶园管理"),i("div",{class:"title"},"茶园总览"),i("div",{class:"sub"},"统一视图管理茶园、地块与设备情况")],-1)),r((n(),s(l,{type:"primary",icon:"Plus",onClick:re},{default:p((()=>[...a[23]||(a[23]=[m("新增茶园",-1)])])),_:1})),[[ze,["super_admin"]]])]),i("div",z,[c(x,{inline:!0,model:D,"label-width":"80px"},{default:p((()=>[c(y,{label:"名称"},{default:p((()=>[c(t,{modelValue:D.name,"onUpdate:modelValue":a[0]||(a[0]=e=>D.name=e),placeholder:"输入茶园名称",clearable:""},null,8,["modelValue"])])),_:1}),c(y,{label:"所属"},{default:p((()=>[c(b,{modelValue:D.company,"onUpdate:modelValue":a[1]||(a[1]=e=>D.company=e),placeholder:"选择合作社",clearable:""},{default:p((()=>[c(_,{label:"西湖集团",value:"xh"}),c(_,{label:"安吉白茶合作社",value:"aj"})])),_:1},8,["modelValue"])])),_:1}),c(y,null,{default:p((()=>[c(l,{type:"primary",icon:"Search",onClick:ne},{default:p((()=>[...a[25]||(a[25]=[m("搜索",-1)])])),_:1}),c(l,{icon:"Refresh",onClick:ue},{default:p((()=>[...a[26]||(a[26]=[m("重置",-1)])])),_:1})])),_:1})])),_:1},8,["model"])]),i("div",S,[c(O,{data:H.value,style:{width:"100%"},stripe:""},{default:p((()=>[c(E,{prop:"id",label:"ID",width:"80"}),c(E,{prop:"name",label:"茶园名称","min-width":"180"}),c(E,{prop:"address",label:"位置","show-overflow-tooltip":""}),c(E,{prop:"plotCount",label:"地块数",width:"90"}),c(E,{label:"在线设备",width:"140"},{default:p((({row:e})=>[i("span",j,v(e.onlineCount),1),m(" / "+v(e.totalCount),1)])),_:1}),c(E,{prop:"manager",label:"负责人",width:"120"}),c(E,{label:"操作",width:"240",fixed:"right"},{default:p((({row:e})=>[c(l,{link:"",type:"primary",onClick:a=>{return l=e.id,void B.push(`/tea-garden/detail/${l}`);var l}},{default:p((()=>[...a[27]||(a[27]=[m("详情",-1)])])),_:1},8,["onClick"]),r((n(),s(l,{link:"",type:"primary",onClick:a=>(e=>{Z.value=!0,G.value=e.id,Q.name=e.name,Q.company=e.company,Q.manager=e.manager,Q.address=e.address,Q.area=e.area,Q.latitude=e.latitude,Q.longitude=e.longitude,Q.longitude=e.longitude,Q.camera_url=e.camera_url,Q.image_path=e.image_path,Q.desc=e.desc,$.value=!0})(e)},{default:p((()=>[...a[28]||(a[28]=[m("编辑",-1)])])),_:1},8,["onClick"])),[[ze,["admin","super_admin"]]]),r((n(),s(l,{link:"",type:"success",onClick:a=>(async e=>{te.value=e.id,Y.value=!0,le.value=[];try{const a=await V({page:1,size:1e3});ae.value=a.list||[],setTimeout((()=>{oe.value&&(oe.value.clearSelection(),ae.value.forEach((a=>{a.garden_id===e.id&&oe.value.toggleRowSelection(a,!0)})))}),100)}catch(a){console.error(a)}})(e)},{default:p((()=>[...a[29]||(a[29]=[m("绑定设备",-1)])])),_:1},8,["onClick"])),[[ze,["admin","super_admin"]]]),r((n(),s(l,{link:"",type:"danger",onClick:a=>(e=>{h.confirm("确定要停用该茶园吗？此操作不可恢复","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{try{await w(e.id),f.success("已停用"),de()}catch(a){console.error(a)}}))})(e)},{default:p((()=>[...a[30]||(a[30]=[m("停用",-1)])])),_:1},8,["onClick"])),[[ze,["admin","super_admin"]]])])),_:1})])),_:1},8,["data"]),i("div",M,[c(se,{background:"",layout:"prev, pager, next",total:K.value,"current-page":D.page,"onUpdate:currentPage":a[2]||(a[2]=e=>D.page=e),"page-size":D.size,onCurrentChange:ie},null,8,["total","current-page","page-size"])])]),c(Ce,{modelValue:$.value,"onUpdate:modelValue":a[14]||(a[14]=e=>$.value=e),title:Z.value?"编辑茶园":"新增茶园",width:"500px"},{footer:p((()=>[i("span",L,[c(l,{onClick:a[13]||(a[13]=e=>$.value=!1)},{default:p((()=>[...a[34]||(a[34]=[m("取消",-1)])])),_:1}),c(l,{type:"primary",onClick:pe,loading:N.value},{default:p((()=>[...a[35]||(a[35]=[m("确定",-1)])])),_:1},8,["loading"])])])),default:p((()=>[c(x,{model:Q,"label-width":"80px",ref_key:"formRef",ref:J,rules:X},{default:p((()=>[c(y,{label:"茶园名称",prop:"name"},{default:p((()=>[c(t,{modelValue:Q.name,"onUpdate:modelValue":a[3]||(a[3]=e=>Q.name=e),placeholder:"请输入茶园名称"},null,8,["modelValue"])])),_:1}),c(y,{label:"茶园封面"},{default:p((()=>{return[i("div",{onClick:a[4]||(a[4]=e=>W.value=!0),style:{width:"100%",height:"120px",border:"1px dashed #dcdfe6","border-radius":"4px",display:"flex","justify-content":"center","align-items":"center",cursor:"pointer",position:"relative",overflow:"hidden"}},[Q.image_path?(n(),u("img",{key:0,src:(e=Q.image_path,e?e.startsWith("http")?e:e.startsWith("/")?"http://116.62.25.191:1112/api"+e:e:""),style:{width:"100%",height:"100%","object-fit":"cover"}},null,8,P)):(n(),u("div",A,[c(ye,{size:24},{default:p((()=>[c(he)])),_:1}),a[31]||(a[31]=i("span",{style:{"font-size":"12px","margin-top":"4px"}},"点击选择封面",-1))]))])];var e})),_:1}),c(y,{label:"所属公司",prop:"company"},{default:p((()=>[c(b,{modelValue:Q.company,"onUpdate:modelValue":a[5]||(a[5]=e=>Q.company=e),placeholder:"请选择",style:{width:"100%"}},{default:p((()=>[c(_,{label:"西湖集团",value:"xh"}),c(_,{label:"安吉白茶合作社",value:"aj"})])),_:1},8,["modelValue"])])),_:1}),c(y,{label:"负责人",prop:"manager"},{default:p((()=>[c(t,{modelValue:Q.manager,"onUpdate:modelValue":a[6]||(a[6]=e=>Q.manager=e),placeholder:"请输入负责人姓名"},null,8,["modelValue"])])),_:1}),c(y,{label:"联系地址",prop:"address"},{default:p((()=>[c(t,{modelValue:Q.address,"onUpdate:modelValue":a[7]||(a[7]=e=>Q.address=e),placeholder:"请输入详细地址"},null,8,["modelValue"])])),_:1}),c(y,{label:"占地面积",prop:"area"},{default:p((()=>[c(t,{modelValue:Q.area,"onUpdate:modelValue":a[8]||(a[8]=e=>Q.area=e),modelModifiers:{number:!0},placeholder:"请输入面积"},{append:p((()=>[...a[32]||(a[32]=[m("亩",-1)])])),_:1},8,["modelValue"])])),_:1}),c(y,{label:"地理位置",required:""},{default:p((()=>[c(Ve,{gutter:10,style:{width:"100%"}},{default:p((()=>[c(_e,{span:10},{default:p((()=>[c(t,{modelValue:Q.longitude,"onUpdate:modelValue":a[9]||(a[9]=e=>Q.longitude=e),placeholder:"经度",readonly:""},null,8,["modelValue"])])),_:1}),c(_e,{span:10},{default:p((()=>[c(t,{modelValue:Q.latitude,"onUpdate:modelValue":a[10]||(a[10]=e=>Q.latitude=e),placeholder:"纬度",readonly:""},null,8,["modelValue"])])),_:1}),c(_e,{span:4},{default:p((()=>[c(l,{type:"primary",icon:"Location",onClick:be,style:{width:"100%"}},{default:p((()=>[...a[33]||(a[33]=[m("选点",-1)])])),_:1})])),_:1})])),_:1})])),_:1}),c(y,{label:"摄像头",prop:"camera_url"},{default:p((()=>[c(t,{modelValue:Q.camera_url,"onUpdate:modelValue":a[11]||(a[11]=e=>Q.camera_url=e),placeholder:"RTSP/HLS 视频流地址"},null,8,["modelValue"])])),_:1}),c(y,{label:"描述信息",prop:"desc"},{default:p((()=>[c(t,{modelValue:Q.desc,"onUpdate:modelValue":a[12]||(a[12]=e=>Q.desc=e),type:"textarea",rows:"3",placeholder:"请输入描述信息"},null,8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue","title"]),c(Ce,{modelValue:Y.value,"onUpdate:modelValue":a[17]||(a[17]=e=>Y.value=e),title:"绑定设备",width:"600px"},{footer:p((()=>[i("span",T,[c(l,{onClick:a[16]||(a[16]=e=>Y.value=!1)},{default:p((()=>[...a[36]||(a[36]=[m("取消",-1)])])),_:1}),c(l,{type:"primary",onClick:ce,loading:ee.value},{default:p((()=>[...a[37]||(a[37]=[m("确认绑定",-1)])])),_:1},8,["loading"])])])),default:p((()=>[a[38]||(a[38]=i("div",{class:"mb-4 text-gray-500"},"请选择要绑定到该茶园的设备：",-1)),c(O,{ref_key:"bindTableRef",ref:oe,data:ae.value,style:{width:"100%"},height:"300",onSelectionChange:a[15]||(a[15]=e=>le.value=e.map((e=>e.id)))},{default:p((()=>[c(E,{type:"selection",width:"55"}),c(E,{prop:"name",label:"设备名称"}),c(E,{prop:"sn",label:"序列号"}),c(E,{prop:"status",label:"状态"},{default:p((({row:e})=>[c(Ue,{size:"small",type:"online"===e.status?"success":"info"},{default:p((()=>[m(v(e.status),1)])),_:2},1032,["type"])])),_:1})])),_:1},8,["data"])])),_:1},8,["modelValue"]),c(Ce,{modelValue:me.value,"onUpdate:modelValue":a[20]||(a[20]=e=>me.value=e),title:"地图选点",width:"800px",top:"5vh",onOpened:we},{footer:p((()=>[i("span",I,[c(l,{onClick:a[19]||(a[19]=e=>me.value=!1)},{default:p((()=>[...a[41]||(a[41]=[m("取消",-1)])])),_:1}),c(l,{type:"primary",onClick:ke,disabled:!ge.value},{default:p((()=>[...a[42]||(a[42]=[m("确定使用该位置",-1)])])),_:1},8,["disabled"])])])),default:p((()=>[i("div",R,[i("div",q,[c(t,{modelValue:ve.value,"onUpdate:modelValue":a[18]||(a[18]=e=>ve.value=e),placeholder:"输入关键字搜索地址",id:"map-search-input",clearable:"",onKeyup:g(xe,["enter"])},null,8,["modelValue"]),c(l,{type:"primary",onClick:xe},{default:p((()=>[...a[39]||(a[39]=[m("搜索",-1)])])),_:1})]),a[40]||(a[40]=i("div",{id:"select-map-container",style:{width:"100%",height:"500px","border-radius":"4px",border:"1px solid #dcdfe6"}},null,-1)),i("div",F," 当前选中: 经度 "+v(fe.value||"-")+", 纬度 "+v(ge.value||"-"),1)])])),_:1},8,["modelValue"]),c(k,{modelValue:W.value,"onUpdate:modelValue":a[21]||(a[21]=e=>W.value=e),"current-image":Q.image_path,onSelect:a[22]||(a[22]=e=>Q.image_path=e)},null,8,["modelValue","current-image"])])}},__scopeId:"data-v-655dd82e"};export{E as default};
