import{a1 as e,u as a,e as t,g as l,h as s,r as i,$ as o,k as n,o as r,i as c,j as d,a as u,n as v,q as p,w as m,l as f,m as g,c as w,F as y,y as h,a2 as _,V as b}from"./vendor.da7b8729.js";import{a as x}from"./tea-garden.34ed79bb.js";import{g as k,a as A}from"./device.2995e9c4.js";import{g as M}from"./rule.85422e5a.js";import"./index.e41e9f95.js";const I={class:"page"},$={class:"page-header"},j={class:"flex-center"},C={class:"title"},F={class:"card mb-4",style:{height:"400px",padding:"0",overflow:"hidden",position:"relative"}},P={id:"garden-map",style:{width:"100%",height:"100%",background:"#e0e0e0"}},N={key:0,class:"map-placeholder"},D={class:"map-overlay"},E={class:"weather-widget"},O={class:"temp"},S={class:"desc"},T={class:"card"},z={class:"camera-container"},L={key:0,class:"video-player"},G={class:"placeholder-video"},W={class:"url-text"},V={class:"card mb-4"},J={class:"card-title"},R={key:0,style:{"font-size":"12px",color:"#999","font-weight":"normal","margin-left":"10px"}},U={key:0,class:"sensor-grid"},q={class:"mini-info"},H={class:"light"},K={class:"bold"},Y={class:"card mb-4"},B={class:"growth-status"},Q={class:"card"},X={class:"ai-advice"},Z={__name:"detail",setup(Z){const ee=e(),ae=a(),te=ee.params.id,le=t({}),se=t(!1),ie=t(!1),oe=t({}),ne=t({temperature:"-",weather:"加载中",humidity:"-",windPower:"-"}),re=t([]),ce=t(""),de=t([{type:"info",text:"正在分析环境数据..."}]),ue=async()=>{try{const e=await M();e&&e.forEach((e=>{try{oe.value[e.sensor_key]=JSON.parse(e.rule_config)}catch(a){}}))}catch(e){console.error(e)}},ve=(e,a)=>{const t=parseFloat(a);if(isNaN(t))return null;const l=oe.value[e];if(!l)return null;for(const s of l){const e=null!==s.min&&void 0!==s.min?s.min:-1/0,a=null!==s.max&&void 0!==s.max?s.max:1/0;if(t>=e&&t<a)return{label:s.label,color:s.color}}return null},pe=(e,a)=>{window.AMap?window.AMap.plugin(["AMap.Geocoder","AMap.Weather"],(function(){(new window.AMap.Geocoder).getAddress([a,e],((e,a)=>{if(console.log("Geocoder status:",e,a),"complete"===e&&a.regeocode){const e=a.regeocode.addressComponent.adcode;me(e)}else console.warn("Geocode failed:",a),me("330100")}))})):setTimeout((()=>pe(e,a)),500)},me=e=>{(new window.AMap.Weather).getLive(e,((e,a)=>{if(console.log("Weather result:",e,a),e){const a=e.info||"未知错误";"USERKEY_PLAT_NOMATCH"!==a&&"INVALID_USER_SCODE"!==a||(ne.value={temperature:"26",weather:"晴",humidity:"45",windPower:"3"})}else ne.value={temperature:a.temperature,weather:a.weather,humidity:a.humidity,windPower:a.windPower}}))},fe=async()=>{try{console.log("Fetching devices for gardenId:",te);const e=(await k({gardenId:te,size:100})).list||[];console.log("Devices found:",e);const a=[],t=e.map((async e=>{try{const l=await A(e.id);console.log(`Telemetry for device ${e.id}:`,l);let s={};try{e.sensor_config&&(s=JSON.parse(e.sensor_config))}catch(t){console.error("Config parse error",t)}const i={};Array.isArray(l)?l.forEach((e=>{i[e.key]||(i[e.key]=e.value)})):"object"==typeof l&&Object.assign(i,l),console.log(`Processed latestData for ${e.id}:`,i);for(const[t,o]of Object.entries(i)){if(s.__ignored&&s.__ignored.includes(t))continue;if("ts"===t)continue;const l=s[t]||{},i=l.name||t,n=l.unit||"",r=ve(t,o);a.push({label:i,value:o+(n?" "+n:""),deviceId:e.id,deviceName:e.name,status:r?r.label:null,statusColor:r?r.color:null})}}catch(t){console.error(`Failed to fetch telemetry for device ${e.id}`,t)}}));await Promise.all(t),console.log("Final sensor list:",a),re.value=a,ce.value=(new Date).toLocaleTimeString(),ge(a)}catch(e){console.error(e)}},ge=e=>{const a=[],t=e.find((e=>e.label.includes("湿度")));if(t){const e=parseFloat(t.value);e>80?a.push({type:"warning",text:`检测到${t.label}较高(${e}%)，请注意防范茶饼病。`}):e<40&&a.push({type:"warning",text:`检测到${t.label}较低(${e}%)，请注意适时灌溉。`})}const l=e.find((e=>e.label.includes("温度")));if(l){const e=parseFloat(l.value);e>30?a.push({type:"warning",text:`气温较高(${e}℃)，请注意茶树遮阳防晒。`}):e<5&&a.push({type:"warning",text:`气温较低(${e}℃)，请注意防冻害。`})}0===a.length&&(a.push({type:"info",text:"当前环境适宜，建议进行常规巡园。"}),a.push({type:"info",text:"适宜进行除草作业。"})),de.value=a},we=(e,a)=>{if(!window.AMap)return void setTimeout((()=>we(e,a)),500);ie.value=!0;const t=new window.AMap.Map("garden-map",{zoom:16,center:[a,e],viewMode:"3D"}),l=new window.AMap.Marker({position:[a,e],title:le.value.name});t.add(l)};let ye=null;return l((()=>{(async()=>{se.value=!0;try{await ue();const e=await x(te);e&&(le.value=e,e.latitude&&e.longitude&&(we(e.latitude,e.longitude),pe(e.latitude,e.longitude)),fe())}catch(e){console.error(e)}finally{se.value=!1}})(),ye=setInterval((()=>{te&&fe()}),5e3)})),s((()=>{ye&&(clearInterval(ye),ye=null)})),(e,a)=>{const t=i("el-button"),l=i("el-tag"),s=i("el-space"),x=i("el-empty"),k=i("VideoCamera"),A=i("el-icon"),M=i("el-col"),Z=i("el-step"),ee=i("el-steps"),te=i("Warning"),oe=i("InfoFilled"),ue=i("el-row"),ve=o("loading");return n((r(),c("div",I,[d("div",$,[d("div",j,[u(t,{icon:"ArrowLeft",circle:"",onClick:a[0]||(a[0]=e=>v(ae).back()),class:"mr-4"}),d("div",null,[a[1]||(a[1]=d("div",{class:"eyebrow"},"茶园详情",-1)),d("div",C,p(le.value.name||"加载中..."),1)])]),u(s,null,{default:m((()=>[u(l,null,{default:m((()=>[f(p(le.value.company),1)])),_:1}),u(l,{type:"info"},{default:m((()=>[f(p(le.value.manager),1)])),_:1})])),_:1})]),u(ue,{gutter:20},{default:m((()=>[u(M,{span:16},{default:m((()=>[d("div",F,[d("div",P,[ie.value?g("",!0):(r(),c("div",N,[u(x,{description:"地图加载中或未配置经纬度"})]))]),d("div",D,[d("div",E,[d("div",O,p(ne.value.temperature)+"°C",1),d("div",S,p(ne.value.weather)+" | 湿度 "+p(ne.value.humidity)+"% | 风速 "+p(ne.value.windPower)+"级",1)])])]),d("div",T,[a[3]||(a[3]=d("div",{class:"card-title"},"实时监控",-1)),d("div",z,[le.value.camera_url?(r(),c("div",L,[d("div",G,[u(A,{size:40},{default:m((()=>[u(k)])),_:1}),a[2]||(a[2]=d("div",{class:"mt-2"},"摄像头画面接入中...",-1)),d("div",W,p(le.value.camera_url),1)])])):(r(),w(x,{key:1,description:"未配置摄像头"}))])])])),_:1}),u(M,{span:8},{default:m((()=>[d("div",V,[d("div",J,[a[4]||(a[4]=f(" 环境数据 ",-1)),ce.value?(r(),c("span",R," 更新于 "+p(ce.value),1)):g("",!0)]),re.value.length>0?(r(),c("div",U,[(r(!0),c(y,null,h(re.value,((e,a)=>(r(),c("div",{class:"sensor-item",key:a},[d("div",{class:"status-text",style:_({color:e.statusColor||"#303133"})},p(e.status||"监测中"),5),d("div",q,[d("span",H,p(e.label),1),d("span",K,p(e.value),1)])])))),128))])):(r(),w(x,{key:1,description:"暂无传感器数据","image-size":60}))]),d("div",Y,[a[5]||(a[5]=d("div",{class:"card-title"},"茶叶生长状态",-1)),d("div",B,[u(ee,{direction:"vertical",active:2},{default:m((()=>[u(Z,{title:"萌芽期",description:"3月1日 - 3月15日"}),u(Z,{title:"生长期",description:"当前阶段，预计持续至4月",status:"process"}),u(Z,{title:"采摘期",description:"预计4月中旬开始"})])),_:1})])]),d("div",Q,[a[6]||(a[6]=d("div",{class:"card-title"},"AI 农事建议",-1)),d("div",X,[(r(!0),c(y,null,h(de.value,((e,a)=>(r(),c("div",{key:a,class:b(["advice-item",e.type])},["warning"===e.type?(r(),w(A,{key:0},{default:m((()=>[u(te)])),_:1})):(r(),w(A,{key:1},{default:m((()=>[u(oe)])),_:1})),d("span",null,p(e.text),1)],2)))),128))])])])),_:1})])),_:1})])),[[ve,se.value]])}},__scopeId:"data-v-06815b4c"};export{Z as default};
