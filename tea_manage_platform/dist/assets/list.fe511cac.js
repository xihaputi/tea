import{e,S as a,h as l,r as t,$ as o,o as n,c as s,w as u,k as r,i as d,j as i,a as c,l as m,q as p,F as v,y,R as f,f as h,D as _,g as w,V as b,m as g,H as k,E as V,v as x}from"./vendor.da7b8729.js";import{b as D,g as C,a as T,c as q,d as U,u as E,e as M}from"./device.2995e9c4.js";import{i as S}from"./index.2376e022.js";import"./index.e41e9f95.js";const O={class:"history-container"},j={class:"toolbar"},Y={class:"table-container"},$={__name:"DeviceHistory",setup(h,{expose:_}){const w=e(!1),b=e(!1),g=e(null);let k=null;const V=e(null),x=e=>{if(!V.value)return e;try{const a=JSON.parse(V.value.sensor_config||"{}");if(a[e]&&a[e].name)return a[e].name}catch(a){}return e},C=e([a().subtract(24,"hour").toDate(),a().toDate()]),T=[{text:"最近1小时",value:()=>[a().subtract(1,"hour").toDate(),a().toDate()]},{text:"最近24小时",value:()=>[a().subtract(24,"hour").toDate(),a().toDate()]},{text:"最近7天",value:()=>[a().subtract(7,"day").toDate(),a().toDate()]}],q=e([]),U=e([]),E=()=>{k&&(k.dispose(),k=null)},M=()=>{g.value&&(k=S(g.value),window.addEventListener("resize",$))},$=()=>{null==k||k.resize()};l((()=>{window.removeEventListener("resize",$),null==k||k.dispose()}));const z=async()=>{if(V.value&&C.value){b.value=!0;try{const[e,l]=C.value,t={startTs:a(e).toISOString(),endTs:a(l).toISOString()},o=await D(V.value.id,t);I(o)}catch(e){console.error(e)}finally{b.value=!1}}},I=e=>{if(!e||0===Object.keys(e).length)return q.value=[],U.value=[],void(null==k||k.clear());const l=Object.keys(e);U.value=l;let t={};try{t=JSON.parse(V.value.sensor_config||"{}")}catch(d){}const o=e=>t[e]&&t[e].name?t[e].name:e,n=e=>t[e]&&t[e].unit?t[e].unit:"",s=l.map((a=>({name:o(a),type:"line",smooth:!0,showSymbol:!1,data:e[a].map((e=>[new Date(e.ts),parseFloat(e.value)])),unit:n(a)}))),u={tooltip:{trigger:"axis",formatter:function(e){let l=a(e[0].value[0]).format("YYYY-MM-DD HH:mm:ss")+"<br/>";return e.forEach((e=>{const a=s[e.seriesIndex],t=a?a.unit:"";l+=e.marker+e.seriesName+": "+e.value[1]+" "+t+"<br/>"})),l}},legend:{data:s.map((e=>e.name)),bottom:0},grid:{left:"3%",right:"4%",bottom:"10%",containLabel:!0},xAxis:{type:"time",boundaryGap:!1},yAxis:{type:"value"},series:s};null==k||k.setOption(u,!0);const r=new Map;l.forEach((a=>{e[a].forEach((e=>{const l=e.ts;r.has(l)||r.set(l,{ts:l}),r.get(l)[a]=e.value}))})),q.value=Array.from(r.values()).sort(((e,a)=>new Date(a.ts)-new Date(e.ts)))};return _({open:e=>{V.value=e,w.value=!0,f((()=>{M(),z()}))}}),(e,l)=>{const f=t("el-date-picker"),h=t("el-button"),_=t("el-space"),k=t("el-table-column"),V=t("el-table"),D=t("el-dialog"),M=o("loading");return n(),s(D,{modelValue:w.value,"onUpdate:modelValue":l[1]||(l[1]=e=>w.value=e),title:"历史数据与曲线",width:"900px","destroy-on-close":"",onClose:E},{default:u((()=>[r((n(),d("div",O,[i("div",j,[c(_,null,{default:u((()=>[l[3]||(l[3]=i("span",{class:"label"},"时间范围:",-1)),c(f,{modelValue:C.value,"onUpdate:modelValue":l[0]||(l[0]=e=>C.value=e),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间",shortcuts:T,onChange:z,style:{width:"380px"}},null,8,["modelValue"]),c(h,{type:"primary",icon:"Refresh",onClick:z},{default:u((()=>[...l[2]||(l[2]=[m("刷新",-1)])])),_:1})])),_:1})]),i("div",{class:"chart-container",ref_key:"chartRef",ref:g},null,512),i("div",Y,[l[4]||(l[4]=i("div",{class:"section-title"},"详细数据",-1)),c(V,{data:q.value,border:"",style:{width:"100%"},height:"300"},{default:u((()=>[c(k,{prop:"ts",label:"时间",width:"180"},{default:u((({row:e})=>{return[m(p((l=e.ts,a(l).format("YYYY-MM-DD HH:mm:ss"))),1)];var l})),_:1}),(n(!0),d(v,null,y(U.value,(e=>(n(),s(k,{key:e,prop:e,label:x(e)},null,8,["prop","label"])))),128))])),_:1},8,["data"])])])),[[M,b.value]])])),_:1},8,["modelValue"])}},__scopeId:"data-v-635ea835"};const z={class:"page"},I={class:"page-header"},Q={class:"card"},H={class:"card"},N={class:"toolbar"},A={class:"flex-center"},R={key:0},B={key:1,class:"text-gray-400 text-xs"},J={class:"dialog-footer"},L={class:"mb-4 text-gray-500 text-sm flex-center",style:{"justify-content":"space-between"}},P={class:"dialog-footer"},F={__name:"list",setup(a){const l=e(""),f=e("all"),D=e([]),S=e([]),O=e(!1),j=e(null),Y=e(!1),F=e(!1),G=e(!1),K=e(null),W=e(null),X=h({name:"",sn:"",product_id:null,mqtt_username:"",mqtt_password:""}),Z=e(!1),ee=e(!1),ae=e(!1),le=e(null),te=e([]),oe={name:[{required:!0,message:"请输入设备名称",trigger:"blur"}],sn:[{required:!0,message:"请输入设备序列号",trigger:"blur"}],product_id:[{required:!0,message:"请选择所属产品",trigger:"change"}]},ne=async()=>{O.value=!0;try{const e={keyword:l.value,status:"all"===f.value?void 0:f.value},a=await C(e);a&&(S.value=a.list||[],S.value.forEach((e=>{se(e)})))}catch(e){console.error(e)}finally{O.value=!1}},se=async e=>{try{const a=await T(e.id);a&&(e.telemetryData={},a.forEach((a=>{e.telemetryData[a.key]=a.value})))}catch(a){console.error(a)}},ue=e=>{if(!e)return{};try{return JSON.parse(e)}catch(a){return{}}},re=(e,a)=>e.telemetryData&&void 0!==e.telemetryData[a]?e.telemetryData[a]:"-",de=()=>{ne()},ie=()=>{G.value=!1,K.value=null,ve(),Y.value=!0},ce=()=>{let e=0;te.value.forEach((a=>{const l=a.key.match(/^sensor(\d+)$/);if(l){const a=parseInt(l[1]);a>e&&(e=a)}}));const a=`sensor${e+1}`;te.value.push({key:a,name:"",unit:"",show:!0,value:"-"})},me=()=>{k.confirm("此操作将把所有键名重命名为 sensor1, sensor2... 格式，且不可撤销。请确保设备端也同步修改发送的键名。是否继续？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{te.value.forEach(((e,a)=>{e.key=`sensor${a+1}`})),V.success("键名已标准化，请点击保存配置")})).catch((()=>{}))},pe=async()=>{ae.value=!0;try{const e={},a=new Set;te.value.forEach((l=>{e[l.key]={name:l.name,unit:l.unit,show:l.show},a.add(l.key)}));const l=[];le.value.telemetryData&&Object.keys(le.value.telemetryData).forEach((e=>{a.has(e)||l.push(e)}));const t=ue(le.value.sensor_config);t.__ignored&&t.__ignored.forEach((e=>{a.has(e)||l.includes(e)||l.push(e)})),l.length>0&&(e.__ignored=l),await E(le.value.id,{sensor_config:JSON.stringify(e)}),V.success("配置已保存"),Z.value=!1,ne()}catch(e){console.error(e),V.error("保存失败")}finally{ae.value=!1}},ve=()=>{X.name="",X.sn="",X.product_id=null,X.mqtt_username="",X.mqtt_password=""},ye=async()=>{W.value&&await W.value.validate((async e=>{if(e){F.value=!0;try{G.value?(await E(K.value,X),V.success("更新成功")):(await M(X),V.success("注册成功")),Y.value=!1,ne()}catch(a){console.error(a)}finally{F.value=!1}}}))},fe=e=>{navigator.clipboard.writeText(e).then((()=>{V.success("已复制")})).catch((()=>{V.error("复制失败")}))},he=_((()=>{const e=X.sn||"{序列号}";let a="{type}";if(X.product_id){const e=D.value.find((e=>e.id===X.product_id));if(e){const l=e.label;a=l.includes("气象站")?"weather":l.includes("土壤")?"sensor":l.includes("阀门")||l.includes("水肥")?"contral":"device"}}return`tea/${a}/${e}/telemetry`})),_e=_((()=>{const e=he.value;return e.includes("contral")?e.replace("telemetry","sub"):""}));return w((()=>{(async()=>{try{const e=await q();e&&(D.value=e)}catch(e){console.error(e)}})(),ne()})),(e,a)=>{const h=t("el-button"),_=t("el-tree"),w=t("el-col"),C=t("el-input"),q=t("el-option"),E=t("el-select"),M=t("el-space"),O=t("el-table-column"),se=t("el-tag"),ve=t("el-table"),we=t("el-row"),be=t("el-form-item"),ge=t("el-divider"),ke=t("el-form"),Ve=t("el-dialog"),xe=t("el-switch"),De=o("permission"),Ce=o("loading");return n(),d("div",z,[i("div",I,[a[14]||(a[14]=i("div",null,[i("div",{class:"eyebrow"},"设备管理"),i("div",{class:"title"},"物联设备总览"),i("div",{class:"sub"},"分组、状态、遥测一站式管理")],-1)),r((n(),s(h,{type:"primary",icon:"Plus",onClick:ie},{default:u((()=>[...a[13]||(a[13]=[m("注册新设备",-1)])])),_:1})),[[De,["admin","super_admin"]]])]),c(we,{gutter:16},{default:u((()=>[c(w,{span:5},{default:u((()=>[i("div",Q,[a[15]||(a[15]=i("div",{class:"card-title"},"产品分组",-1)),c(_,{data:D.value,"default-expand-all":"","highlight-current":""},null,8,["data"])])])),_:1}),c(w,{span:19},{default:u((()=>[i("div",H,[i("div",N,[c(C,{modelValue:l.value,"onUpdate:modelValue":a[0]||(a[0]=e=>l.value=e),placeholder:"设备名称/ID",style:{width:"220px"},clearable:""},null,8,["modelValue"]),c(M,null,{default:u((()=>[c(E,{modelValue:f.value,"onUpdate:modelValue":a[1]||(a[1]=e=>f.value=e),placeholder:"状态",style:{width:"120px"},clearable:""},{default:u((()=>[c(q,{label:"全部",value:"all"}),c(q,{label:"在线",value:"online"}),c(q,{label:"离线",value:"offline"})])),_:1},8,["modelValue"]),c(h,{type:"primary",icon:"Search",onClick:de},{default:u((()=>[...a[16]||(a[16]=[m("查询",-1)])])),_:1})])),_:1})]),c(ve,{data:S.value,style:{width:"100%"}},{default:u((()=>[c(O,{prop:"name",label:"设备名称"}),c(O,{prop:"sn",label:"序列号",width:"180"}),c(O,{prop:"productName",label:"所属产品",width:"140"}),c(O,{label:"状态",width:"110"},{default:u((({row:e})=>[i("div",A,[i("span",{class:b(["dot","online"===e.status?"bg-green":"bg-gray"])},null,2),m(" "+p("online"===e.status?"在线":"离线"),1)])])),_:1}),c(O,{label:"实时数据","min-width":"200"},{default:u((({row:e})=>[e.sensor_config?(n(),d("div",R,[(n(!0),d(v,null,y(ue(e.sensor_config),((a,l)=>r((n(),s(se,{key:l,size:"small",style:{"margin-right":"4px","margin-bottom":"4px"}},{default:u((()=>[m(p(a.name||l)+": "+p(re(e,l))+" "+p(a.unit||""),1)])),_:2},1024)),[[x,a.show]]))),128))])):(n(),d("span",B,"未配置"))])),_:1}),c(O,{prop:"last_time",label:"最后上报时间",width:"180"}),c(O,{label:"MQTT 账号",width:"120","show-overflow-tooltip":""},{default:u((({row:e})=>[m(p(e.mqtt_username||"-"),1)])),_:1}),c(O,{label:"操作",width:"220"},{default:u((({row:e})=>[r((n(),s(h,{link:"",type:"primary",onClick:a=>(e=>{G.value=!0,K.value=e.id,X.name=e.name,X.sn=e.sn,X.product_id=e.product_id,X.mqtt_username=e.mqtt_username||"",X.mqtt_password=e.mqtt_password||"",Y.value=!0})(e)},{default:u((()=>[...a[17]||(a[17]=[m("编辑",-1)])])),_:1},8,["onClick"])),[[De,["admin","super_admin"]]]),c(h,{link:"",type:"primary",onClick:a=>(e=>{j.value.open(e)})(e)},{default:u((()=>[...a[18]||(a[18]=[m("查看曲线",-1)])])),_:1},8,["onClick"]),r((n(),s(h,{link:"",type:"primary",onClick:a=>(async e=>{le.value=e,Z.value=!0,ee.value=!0,te.value=[];try{const a=await T(e.id),l=ue(e.sensor_config),t=new Set(l.__ignored||[]),o=new Map;Object.keys(l).forEach((e=>{"__ignored"!==e&&o.set(e,{key:e,name:l[e].name||e,unit:l[e].unit||"",show:l[e].show||!1,value:"-"})})),a&&a.forEach((e=>{t.has(e.key)&&!o.has(e.key)||(o.has(e.key)?o.get(e.key).value=e.value:o.set(e.key,{key:e.key,name:e.key,unit:"",show:!1,value:e.value}))})),te.value=Array.from(o.values())}catch(a){console.error(a),V.error("获取数据失败")}finally{ee.value=!1}})(e)},{default:u((()=>[...a[19]||(a[19]=[m("调试",-1)])])),_:1},8,["onClick"])),[[De,["admin","super_admin"]]]),r((n(),s(h,{link:"",type:"danger",onClick:a=>(e=>{k.prompt("此操作将永久删除该设备及其所有历史数据，不可恢复！请输入“确认删除设备”以确认。","危险操作",{confirmButtonText:"确定删除",cancelButtonText:"取消",inputPattern:/^确认删除设备$/,inputErrorMessage:"输入内容不正确",type:"error"}).then((async({value:a})=>{try{await U(e.id),V.success("设备已删除"),ne()}catch(l){console.error(l)}})).catch((()=>{}))})(e)},{default:u((()=>[...a[20]||(a[20]=[m("删除",-1)])])),_:1},8,["onClick"])),[[De,["admin","super_admin"]]])])),_:1})])),_:1},8,["data"])])])),_:1})])),_:1}),c(Ve,{modelValue:Y.value,"onUpdate:modelValue":a[10]||(a[10]=e=>Y.value=e),title:G.value?"编辑设备":"注册新设备",width:"500px"},{footer:u((()=>[i("span",J,[c(h,{onClick:a[9]||(a[9]=e=>Y.value=!1)},{default:u((()=>[...a[25]||(a[25]=[m("取消",-1)])])),_:1}),c(h,{type:"primary",onClick:ye,loading:F.value},{default:u((()=>[...a[26]||(a[26]=[m("确定",-1)])])),_:1},8,["loading"])])])),default:u((()=>[c(ke,{model:X,"label-width":"100px",ref_key:"formRef",ref:W,rules:oe},{default:u((()=>[c(be,{label:"设备名称",prop:"name"},{default:u((()=>[c(C,{modelValue:X.name,"onUpdate:modelValue":a[2]||(a[2]=e=>X.name=e),placeholder:"请输入设备名称"},null,8,["modelValue"])])),_:1}),c(be,{label:"设备序列号",prop:"sn"},{default:u((()=>[c(C,{modelValue:X.sn,"onUpdate:modelValue":a[3]||(a[3]=e=>X.sn=e),placeholder:"唯一标识，如 MAC 地址",disabled:G.value},null,8,["modelValue","disabled"])])),_:1}),c(be,{label:"所属产品",prop:"product_id"},{default:u((()=>[c(E,{modelValue:X.product_id,"onUpdate:modelValue":a[4]||(a[4]=e=>X.product_id=e),placeholder:"请选择",style:{width:"100%"}},{default:u((()=>[(n(!0),d(v,null,y(D.value,(e=>(n(),s(q,{key:e.id,label:e.label,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),c(ge,{"content-position":"left"},{default:u((()=>[...a[21]||(a[21]=[m("MQTT 配置指南",-1)])])),_:1}),c(be,{label:"上报话题"},{default:u((()=>[c(C,{value:he.value,readonly:""},{append:u((()=>[c(h,{onClick:a[5]||(a[5]=e=>fe(he.value)),icon:"CopyDocument"})])),_:1},8,["value"]),a[22]||(a[22]=i("div",{class:"text-gray-400 text-xs mt-1"},"格式: tea/{类型}/{序列号}/telemetry",-1))])),_:1}),_e.value?(n(),s(be,{key:0,label:"订阅话题"},{default:u((()=>[c(C,{value:_e.value,readonly:""},{append:u((()=>[c(h,{onClick:a[6]||(a[6]=e=>fe(_e.value)),icon:"CopyDocument"})])),_:1},8,["value"]),a[23]||(a[23]=i("div",{class:"text-gray-400 text-xs mt-1"},"设备需订阅此话题以接收控制指令",-1))])),_:1})):g("",!0),c(ge,{"content-position":"left"},{default:u((()=>[...a[24]||(a[24]=[m("MQTT 认证信息",-1)])])),_:1}),c(be,{label:"MQTT 用户名",prop:"mqtt_username"},{default:u((()=>[c(C,{modelValue:X.mqtt_username,"onUpdate:modelValue":a[7]||(a[7]=e=>X.mqtt_username=e),placeholder:"设备连接 MQTT 的用户名"},null,8,["modelValue"])])),_:1}),c(be,{label:"MQTT 密码",prop:"mqtt_password"},{default:u((()=>[c(C,{modelValue:X.mqtt_password,"onUpdate:modelValue":a[8]||(a[8]=e=>X.mqtt_password=e),placeholder:"设备连接 MQTT 的密码","show-password":""},null,8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue","title"]),c(Ve,{modelValue:Z.value,"onUpdate:modelValue":a[12]||(a[12]=e=>Z.value=e),title:"传感器配置",width:"710px"},{footer:u((()=>[i("span",P,[c(h,{onClick:a[11]||(a[11]=e=>Z.value=!1)},{default:u((()=>[...a[30]||(a[30]=[m("取消",-1)])])),_:1}),c(h,{type:"primary",onClick:pe,loading:ae.value},{default:u((()=>[...a[31]||(a[31]=[m("保存配置",-1)])])),_:1},8,["loading"])])])),default:u((()=>[r((n(),d("div",null,[i("div",L,[a[29]||(a[29]=i("span",null,"检测到以下传感器数据键值 (基于最近10条遥测数据)：",-1)),c(M,null,{default:u((()=>[c(h,{type:"warning",link:"",onClick:me},{default:u((()=>[...a[27]||(a[27]=[m("一键标准化",-1)])])),_:1}),c(h,{type:"primary",link:"",icon:"Plus",onClick:ce},{default:u((()=>[...a[28]||(a[28]=[m("添加传感器",-1)])])),_:1})])),_:1})]),c(ve,{data:te.value,border:"",style:{width:"100%"}},{default:u((()=>[c(O,{label:"原始键名 (Key)",width:"150"},{default:u((({row:e})=>[c(C,{modelValue:e.key,"onUpdate:modelValue":a=>e.key=a,placeholder:"例如: sensor1",size:"small"},null,8,["modelValue","onUpdate:modelValue"])])),_:1}),c(O,{label:"显示名称",width:"160"},{default:u((({row:e})=>[c(C,{modelValue:e.name,"onUpdate:modelValue":a=>e.name=a,placeholder:"例如: 温度",size:"small"},null,8,["modelValue","onUpdate:modelValue"])])),_:1}),c(O,{label:"单位",width:"100"},{default:u((({row:e})=>[c(C,{modelValue:e.unit,"onUpdate:modelValue":a=>e.unit=a,placeholder:"℃",size:"small"},null,8,["modelValue","onUpdate:modelValue"])])),_:1}),c(O,{label:"当前值",width:"100"},{default:u((({row:e})=>[m(p(e.value),1)])),_:1}),c(O,{label:"列表显示",align:"center",width:"90"},{default:u((({row:e})=>[c(xe,{modelValue:e.show,"onUpdate:modelValue":a=>e.show=a},null,8,["modelValue","onUpdate:modelValue"])])),_:1}),c(O,{label:"操作",align:"center",width:"80"},{default:u((({row:e,$index:a})=>[c(h,{type:"danger",link:"",icon:"Delete",onClick:e=>{return l=a,void te.value.splice(l,1);var l}},null,8,["onClick"])])),_:1})])),_:1},8,["data"])])),[[Ce,ee.value]])])),_:1},8,["modelValue"]),c($,{ref_key:"historyRef",ref:j},null,512)])}},__scopeId:"data-v-2c8aa50d"};export{F as default};
