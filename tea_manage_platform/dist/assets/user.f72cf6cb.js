var e=Object.defineProperty,a=Object.defineProperties,l=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,t=(a,l,r)=>l in a?e(a,l,{enumerable:!0,configurable:!0,writable:!0,value:r}):a[l]=r,n=(e,a)=>{for(var l in a||(a={}))s.call(a,l)&&t(e,l,a[l]);if(r)for(var l of r(a))o.call(a,l)&&t(e,l,a[l]);return e};import{u as d,e as i,f as u,D as p,g as m,r as c,$ as f,o as g,i as y,j as v,a as w,w as _,k as b,c as h,n as k,a4 as V,l as x,F as C,y as O,m as j,H as I,E as S,q as U}from"./vendor.da7b8729.js";import{s as z}from"./index.e41e9f95.js";import{g as P}from"./tea-garden.34ed79bb.js";const $={class:"user-container"},q={class:"header-actions"},T={class:"pagination-container"},B={class:"form-tip text-gray-400 text-xs mt-1"},J={key:0},N={key:1},D={key:2},E={class:"dialog-footer"},F={__name:"user",setup(e){d();const r=i(!1),s=i([]),o=i(0),t=u({page:1,size:10,keyword:""}),F=i(!1),H=i(!1),R=i(null),A=i([]),G=u({id:void 0,username:"",password:"",name:"",roles:"user",garden_ids:[],permissions:[]}),K={username:[{required:!0,message:"请输入用户名",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"}],name:[{required:!0,message:"请输入姓名",trigger:"blur"}],roles:[{required:!0,message:"请选择角色",trigger:"change"}]},L=p((()=>G.id?"编辑用户":"新建用户")),M=async()=>{r.value=!0;try{const a=await(e=t,z({url:"/users",method:"get",params:e}));s.value=a.list,o.value=a.total}catch(a){console.error(a)}finally{r.value=!1}var e},Q=()=>{ee(),F.value=!0},W=e=>{I.confirm(`确定要删除用户 "${e.username}" 吗？`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{try{await(a=e.id,z({url:`/users/${a}`,method:"delete"})),S.success("删除成功"),M()}catch(l){console.error(l)}var a}))},X=e=>{I.confirm(`确定要以 "${e.username}" 的身份登录系统吗？\n当前会话将结束。`,"身份切换",{confirmButtonText:"立即切换",cancelButtonText:"取消",type:"warning"}).then((async()=>{try{const l=await(a=e.id,z({url:`/users/${a}/login_as`,method:"post"}));l&&l.token&&(localStorage.setItem("tea_token",l.token),localStorage.setItem("tea_roles",JSON.stringify(l.userInfo.roles||[])),localStorage.setItem("tea_permissions",JSON.stringify(l.userInfo.permissions||[])),localStorage.setItem("tea_user",JSON.stringify(l.userInfo)),S.success("身份切换成功，正在跳转..."),setTimeout((()=>{window.location.href="/"}),1e3))}catch(l){console.error(l)}var a}))},Y=e=>{"super_admin"===e&&(G.garden_ids=[])},Z=async()=>{R.value&&await R.value.validate((async e=>{if(e){H.value=!0;try{const e=(o=n({},G),t={roles:[G.roles]},a(o,l(t)));if(G.id){const a=n({},e);a.password||delete a.password,await(r=G.id,s=a,z({url:`/users/${r}`,method:"put",data:s})),S.success("更新成功")}else await function(e){return z({url:"/users",method:"post",data:e})}(e),S.success("创建成功");F.value=!1,M()}catch(d){console.error(d)}finally{H.value=!1}}var r,s,o,t}))},ee=()=>{G.id=void 0,G.username="",G.password="",G.name="",G.roles="user",G.garden_ids=[],G.permissions=[],R.value&&R.value.resetFields()};return m((()=>{M(),(async()=>{try{const e=await P({page:1,size:100});A.value=e.list||[]}catch(e){console.error(e)}})()})),(e,a)=>{const l=c("el-icon"),n=c("el-button"),d=c("el-table-column"),i=c("el-tag"),u=c("el-table"),p=c("el-pagination"),m=c("el-input"),I=c("el-form-item"),S=c("el-option"),z=c("el-select"),P=c("el-form"),ae=c("el-dialog"),le=f("permission"),re=f("loading");return g(),y("div",$,[v("div",q,[w(n,{type:"primary",onClick:Q},{default:_((()=>[w(l,{class:"mr-1"},{default:_((()=>[w(k(V))])),_:1}),a[10]||(a[10]=x("新建用户 ",-1))])),_:1})]),b((g(),h(u,{data:s.value,style:{width:"100%"},class:"mt-4"},{default:_((()=>[w(d,{prop:"username",label:"用户名",width:"150"}),w(d,{prop:"name",label:"姓名",width:"150"}),w(d,{label:"角色",width:"150"},{default:_((e=>[(g(!0),y(C,null,O(e.row.roles,(e=>(g(),h(i,{key:e,class:"mr-1"},{default:_((()=>[x(U(e),1)])),_:2},1024)))),128))])),_:1}),w(d,{label:"权限","min-width":"200"},{default:_((e=>[(g(!0),y(C,null,O(e.row.permissions,(e=>(g(),h(i,{key:e,type:"info",class:"mr-1 mb-1"},{default:_((()=>[x(U(e),1)])),_:2},1024)))),128))])),_:1}),w(d,{label:"操作",width:"200",fixed:"right"},{default:_((e=>[w(n,{link:"",type:"primary",onClick:a=>{return l=e.row,ee(),Object.assign(G,l),l.roles&&l.roles.length>0?G.roles=l.roles[0]:G.roles="user",G.password="",void(F.value=!0);var l}},{default:_((()=>[...a[11]||(a[11]=[x("编辑",-1)])])),_:1},8,["onClick"]),b((g(),h(n,{link:"",type:"warning",onClick:a=>X(e.row)},{default:_((()=>[...a[12]||(a[12]=[x("身份登录",-1)])])),_:1},8,["onClick"])),[[le,["super_admin"]]]),w(n,{link:"",type:"danger",onClick:a=>W(e.row)},{default:_((()=>[...a[13]||(a[13]=[x("删除",-1)])])),_:1},8,["onClick"])])),_:1})])),_:1},8,["data"])),[[re,r.value]]),v("div",T,[w(p,{"current-page":t.page,"onUpdate:currentPage":a[0]||(a[0]=e=>t.page=e),"page-size":t.size,"onUpdate:pageSize":a[1]||(a[1]=e=>t.size=e),total:o.value,layout:"total, prev, pager, next",onCurrentChange:M},null,8,["current-page","page-size","total"])]),w(ae,{title:L.value,modelValue:F.value,"onUpdate:modelValue":a[9]||(a[9]=e=>F.value=e),width:"600px",onClose:ee},{footer:_((()=>[v("span",E,[w(n,{onClick:a[8]||(a[8]=e=>F.value=!1)},{default:_((()=>[...a[14]||(a[14]=[x("取消",-1)])])),_:1}),w(n,{type:"primary",onClick:Z,loading:H.value},{default:_((()=>[...a[15]||(a[15]=[x("确定",-1)])])),_:1},8,["loading"])])])),default:_((()=>[w(P,{model:G,rules:K,ref_key:"formRef",ref:R,"label-width":"100px"},{default:_((()=>[w(I,{label:"用户名",prop:"username"},{default:_((()=>[w(m,{modelValue:G.username,"onUpdate:modelValue":a[2]||(a[2]=e=>G.username=e),disabled:!!G.id,placeholder:"请输入用户名"},null,8,["modelValue","disabled"])])),_:1}),G.id?(g(),h(I,{key:1,label:"密码",prop:"password"},{default:_((()=>[w(m,{modelValue:G.password,"onUpdate:modelValue":a[4]||(a[4]=e=>G.password=e),type:"password",placeholder:"留空则不修改","show-password":""},null,8,["modelValue"])])),_:1})):(g(),h(I,{key:0,label:"密码",prop:"password"},{default:_((()=>[w(m,{modelValue:G.password,"onUpdate:modelValue":a[3]||(a[3]=e=>G.password=e),type:"password",placeholder:"请输入密码","show-password":""},null,8,["modelValue"])])),_:1})),w(I,{label:"姓名",prop:"name"},{default:_((()=>[w(m,{modelValue:G.name,"onUpdate:modelValue":a[5]||(a[5]=e=>G.name=e),placeholder:"请输入姓名"},null,8,["modelValue"])])),_:1}),w(I,{label:"用户角色",prop:"roles"},{default:_((()=>[w(z,{modelValue:G.roles,"onUpdate:modelValue":a[6]||(a[6]=e=>G.roles=e),placeholder:"请选择角色",onChange:Y},{default:_((()=>[w(S,{label:"超级管理员",value:"super_admin"}),w(S,{label:"普通管理员",value:"admin"}),w(S,{label:"普通用户",value:"user"})])),_:1},8,["modelValue"]),v("div",B,["super_admin"===G.roles?(g(),y("div",J,"拥有系统所有权限，无需分配茶园。")):j("",!0),"admin"===G.roles?(g(),y("div",N,"管理指定的茶园及所属设备。")):j("",!0),"user"===G.roles?(g(),y("div",D,"仅查看指定的茶园及所属设备。")):j("",!0)])])),_:1}),"super_admin"!==G.roles?(g(),h(I,{key:2,label:"分配茶园"},{default:_((()=>[w(z,{modelValue:G.garden_ids,"onUpdate:modelValue":a[7]||(a[7]=e=>G.garden_ids=e),multiple:"",placeholder:"请选择分配的茶园",style:{width:"100%"}},{default:_((()=>[(g(!0),y(C,null,O(A.value,(e=>(g(),h(S,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})):j("",!0)])),_:1},8,["model"])])),_:1},8,["title","modelValue"])])}},__scopeId:"data-v-77a99913"};export{F as default};
